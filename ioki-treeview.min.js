angular.module("RecursionHelper",[]).factory("RecursionHelper",["$compile",function(a){"use strict";return{compile:function(b,c){angular.isFunction(c)&&(c={post:c});var d,e=b.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c&&c.post&&c.post.apply(null,arguments)}}}}}]),angular.module("ioki.treeview",["RecursionHelper"]).provider("$treeview",function(){"use strict";var a=this.defaults={prefixClass:"treeview-",prefixEvent:"treeview",treesettings:{template:"templates/ioki-treeview",iconsBaseClass:"fa",interfaceIcons:{addNode:"fa-plus-circle",removeNode:"fa-minus-circle",openDir:"fa-caret-down",closeDir:"fa-caret-right"},expandable:!0,expandAll:!0,showExpander:!0,removable:!1,addable:!0,selectable:!1,customMethods:{addNode:null,removeNode:null,dragging:null,drop:null}}};this.$get=function(){function b(b){function c(a,b){var c,f,h;"string"==typeof a&&"undefined"!=typeof b&&(c=e(g),f=c.treedata,h=f.subnodes,f[a]=b,d(h,a,b))}function d(a,b,c){var e,f;if(angular.isArray(a))for(e=0,f=a.length,e;f>e;e++)a[e][b]=c,d(a[e].subnodes,b,c)}function e(a){return"undefined"==typeof a.$parent.$parent.treedata?a:e(a.$parent.$parent)}var f,g,h,i={};f=i.$options=angular.extend({},a,b);for(h in a.treesettings)a.treesettings.hasOwnProperty(h)&&"undefined"==typeof b.treesettings[h]&&(f.treesettings[h]=a.treesettings[h]);if("undefined"!=typeof b.treesettings.interfaceIcons)for(h in a.treesettings.interfaceIcons)a.treesettings.interfaceIcons.hasOwnProperty(h)&&"undefined"==typeof b.treesettings.interfaceIcons[h]&&(f.treesettings.interfaceIcons[h]=a.treesettings.interfaceIcons[h]);return g=i.$scope=f.scope,g.treesettings=f.treesettings,g.treedata.$removable="undefined"!=typeof g.$parent.$parent.treedata&&f.treesettings.removable?!0:!1,f.treesettings.expandAll&&(g.treedata.expanded=!0),g.$addNode=function(a){i.addNode(a)},g.$removeNode=function(){i.removeNode()},g.$toggleNode=function(){i.toggleNode()},g.$selectNode=function(){i.selectNode()},i.toggleNode=function(){f.treesettings.expandable&&(g.treedata.expanded=!g.treedata.expanded)},i.selectNode=function(){var a;f.treesettings.selectable&&(a=g.treedata.selected,c("selected",!1),g.treedata.selected=!a)},i.addNode=function(a){f.treesettings.addable&&"function"==typeof f.treesettings.customMethods.addNode&&f.treesettings.customMethods.addNode(g,a)},i.removeNode=function(){var a,b,c,d=g.treedata;f.treesettings.removable&&("function"==typeof f.treesettings.customMethods.removeNode?f.treesettings.customMethods.removeNode(g):(a=g.$parent.$parent.treedata,"undefined"!=typeof a&&(b=a.subnodes,angular.isArray(b)&&(c=b.indexOf(d),c>-1&&b.splice(c,1)))))},i}return b}}).directive("treeview",["RecursionHelper","$treeview","$templateCache","$compile","$document","$window",function(a,b,c,d,e,f){"use strict";var g;return{restrict:"E",scope:{treedata:"=",treesettings:"="},compile:function(h){return"undefined"==typeof g&&(h.attr("treeview-element-type","root"),g=h),a.compile(h,function(a,h){function i(b){var c=b.pageX+10,d=b.pageY+10,e=angular.element('<li class="separator">DROP ITEM HERE</li>');for(h.css({top:d+"px",left:c+"px"}),"undefined"!=typeof r&&r.remove(),v.el=angular.element(f.document.elementFromPoint(b.pageX,b.pageY)),v.treeview=v.el;"undefined"!=typeof v.treeview[0].tagName&&"treeview"!==v.treeview[0].tagName.toLowerCase();)v.treeview=v.treeview.parent();if(v.list=v.treeview.children().eq(1),k(v.treeview))v.isDroppable=!1;else{if(v.isDroppable=!0,v.scope=v.treeview.scope(),v.node=v.scope.treeData||v.scope.subnode,v.node.subnodes&&v.el.hasClass("node-label"))v.dropToDir=!0,v.list_el=v.treeview,v.list=v.treeview.children().children().eq(-1),"undefined"!=typeof s&&s.removeClass("dropToDir"),s=v.treeview,s.addClass("dropToDir");else{for(v.dropToDir=!1,v.treeview=v.treeview.parent(),v.list_el=v.treeview;"undefined"!=typeof v.treeview[0].tagName&&"treeview"!==v.treeview[0].tagName.toLowerCase();)v.treeview=v.treeview.parent();v.list=v.list_el.after()}v.list.after(e),r=e}v.dropToDir===!1&&"undefined"!=typeof s&&s.removeClass("dropToDir"),"function"==typeof a.treesettings.customMethods.dragging&&a.treesettings.customMethods.dragging(g.scope(),a,v,h)}function j(){var b,c,d,f,k;v.isDroppable&&(v.scope=v.treeview.scope(),v.node=v.scope.treeData||v.scope.subnode,b=a.treedata,k=a.$parent.$parent.treedata,d=k.subnodes.indexOf(b),v.dropToDir?(c=v.node.subnodes.length,v.node.expanded||(v.node.expanded=!0)):(f=v.list_el.children().eq(0).scope().subnode,c=v.node.subnodes.indexOf(f)+1),v.scope.$apply(function(){k.subnodes.splice(d,1),v.node.subnodes.splice(c,0,b)})),"function"==typeof a.treesettings.customMethods.dropped&&a.treesettings.customMethods.dropped(g.scope(),a,v,h),t=u=0,q[0].removeChild(p),"undefined"!=typeof r&&r.remove(),"undefined"!=typeof s&&s.removeClass("dropToDir"),v.isDroppable=!1,g.removeClass("dragging"),h.removeClass("dragged").removeAttr("style"),e.off("mousemove",i).off("mouseup",j)}function k(a){var b=a;if(b.hasClass("ghost")||"root"===b.attr("treeview-element-type"))return!0;for(;"undefined"!=typeof b[0]&&"root"!==b.attr("treeview-element-type");){if("undefined"==typeof b[0].tagName)return!0;if("treeview"===b[0].tagName.toLowerCase()&&b.hasClass("ghost"))return!0;b=b.parent()}return!1}var l,m,n,o,p,q,r,s,t=0,u=0,v={el:null,node:null,list:null,list_el:null,treeview:null,scope:null,dropToDir:!1,isDroppable:!1};l=a.treesettings.template||"templates/ioki-treeview",m=c.get(l),n=d(m)(a),h.append(n),o={scope:a,element:h,treesettings:{}},angular.isDefined(a.treesettings)&&angular.copy(a.treesettings,o.treesettings),b(o),"root"!==h.attr("treeview-element-type")&&h.on("mousedown touchstart",function(a){var b;"i"!==a.target.tagName.toLowerCase()&&"a"!==a.target.tagName.toLowerCase()&&2!==a.button&&3!==a.which&&(a.preventDefault(),a.stopPropagation(),q=h.parent(),p=h[0].cloneNode(!0),p.className="ghost",h.after(p),t=a.pageX-h[0].offsetLeft,u=a.pageY-h[0].offsetTop,b=h[0].offsetWidth,g.addClass("dragging"),h.addClass("dragged").css({left:h[0].offsetLeft+"px",top:h[0].offsetTop+"px",width:b+"px"}),e.on("mousemove touchmove",i).on("mouseup touchend",j))})})}}}]),angular.module("ioki.treeview").run(["$templateCache",function(a){"use strict";a.put("templates/ioki-treeview",'<div ng-class="{\'expanded\': treedata.expanded, \'selected\': treedata.selected}"\n     ng-click="$selectNode()">\n    <!-- expander icon -->\n    <i class="expander {{treesettings.iconsBaseClass}}"\n       ng-class="(treedata.subnodes && treesettings.showExpander) ? (treedata.expanded ? treesettings.interfaceIcons.openDir : treesettings.interfaceIcons.closeDir) : \'invisible\'"\n       ng-click="$toggleNode()"></i>\n\n    <!-- node icon -->\n    <i class="{{treesettings.iconsBaseClass}} {{treedata | getNodeIcon: treesettings.icons}}"></i>\n\n    <!-- node label -->\n    <span class="node-label">{{ treedata.name }}</span>\n\n    <!-- remove node icon -->\n    <i class="remove-node {{treesettings.iconsBaseClass}} {{treesettings.interfaceIcons.removeNode}}"\n       ng-click="$removeNode()"\n       ng-class="{\'invisible\': !treedata.$removable}"></i>\n\n    <!-- add node icon -->\n    <i class="add-node {{treesettings.iconsBaseClass}} {{treesettings.interfaceIcons.addNode}}"\n       ng-click="$addNode()"\n       ng-class="{\'invisible\': (!treesettings.addable || !treedata.subnodes)}"></i>\n</div>\n<ul ng-class="{\'expanded\': treedata.expanded}">\n    <li ng-repeat="subnode in treedata.subnodes track by $index">\n        <treeview treedata="subnode" treesettings="treesettings"></treeview>\n    </li>\n</ul>')}]),angular.module("ioki.treeview").filter("getNodeIcon",function(){"use strict";return function(a,b){var c;return"string"==typeof a.type&&"undefined"!=typeof b[a.type]?(c=b[a.type],null!==c&&"object"==typeof c?(a.expanded=a.expanded||!1,a.expanded?c.open:c.closed):c):null}});