angular.module("RecursionHelper",[]).factory("RecursionHelper",["$compile",function(a){"use strict";return{compile:function(b,c){angular.isFunction(c)&&(c={post:c});var d,e=b.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c&&c.post&&c.post.apply(null,arguments)}}}}}]),angular.module("ioki.treeview",["RecursionHelper","pasvaz.bindonce"]).provider("$treeview",function(){"use strict";var a=this.defaults={prefixClass:"treeview-",prefixEvent:"treeview",treesettings:{template:"templates/ioki-treeview",iconsBaseClass:"fa",interfaceIcons:{addNode:"fa-plus-circle",removeNode:"fa-minus-circle",openDir:"fa-caret-down",closeDir:"fa-caret-right"},expandable:!0,expandAll:!0,showExpander:!0,removable:!1,addable:!0,selectable:!1,customMethods:{addNode:null,removeNode:null,dragStart:null,dragEnd:null,dragging:null,drop:null}}},b={};this.$get=function(){function c(c){function d(a,b){var c,d,h;"string"==typeof a&&"undefined"!=typeof b&&(c=f(g),d=c.treedata,h=d.subnodes,d[a]=b,e(h,a,b))}function e(a,b,c){var d,f;if(angular.isArray(a))for(d=0,f=a.length,d;f>d;d++)a[d][b]=c,e(a[d].subnodes,b,c)}function f(a){return"undefined"==typeof a.$parent.$parent.treedata?a:f(a.$parent.$parent)}var g,h,i={};b=i.$options=angular.extend({},a,c);for(h in a.treesettings)a.treesettings.hasOwnProperty(h)&&"undefined"==typeof c.treesettings[h]&&(b.treesettings[h]=a.treesettings[h]);if("undefined"!=typeof c.treesettings.interfaceIcons)for(h in a.treesettings.interfaceIcons)a.treesettings.interfaceIcons.hasOwnProperty(h)&&"undefined"==typeof c.treesettings.interfaceIcons[h]&&(b.treesettings.interfaceIcons[h]=a.treesettings.interfaceIcons[h]);return g=i.$scope=b.scope,g.treesettings=b.treesettings,g.treedata.$removable="undefined"!=typeof g.$parent.$parent.treedata&&b.treesettings.removable?!0:!1,b.treesettings.expandAll&&!g.treedata.expandAllCalled&&(g.treedata.expanded=!0,g.treedata.expandAllCalled=!0),g.$addNode=function(a){i.addNode(a)},g.$removeNode=function(){i.removeNode()},g.$toggleNode=function(){i.toggleNode()},g.$selectNode=function(){i.selectNode()},i.toggleNode=function(){b.treesettings.expandable&&(g.treedata.expanded=!g.treedata.expanded)},i.selectNode=function(){var a;b.treesettings.selectable&&(a=g.treedata.selected,d("selected",!1),g.treedata.selected=!a)},i.addNode=function(a){b.treesettings.addable&&"function"==typeof b.treesettings.customMethods.addNode&&b.treesettings.customMethods.addNode(g,a)},i.removeNode=function(){var a,c,d,e=g.treedata;b.treesettings.removable&&("function"==typeof b.treesettings.customMethods.removeNode?b.treesettings.customMethods.removeNode(g):(a=g.$parent.$parent.treedata,"undefined"!=typeof a&&(c=a.subnodes,angular.isArray(c)&&(d=c.indexOf(e),d>-1&&c.splice(d,1)))))},i}return c}}).directive("treeview",["RecursionHelper","$treeview","$templateCache","$compile","$document","$window","$q",function(a,b,c,d,e,f,g){"use strict";var h,i={};return{restrict:"E",transclude:!0,scope:{treedata:"=",treesettings:"="},compile:function(j){return"undefined"==typeof h&&(j.attr("treeview-element-type","root"),h={}),a.compile(j,function(a,j){function k(b){var c=b.pageX+10,d=b.pageY+10,e=angular.element('<li class="separator">DROP ITEM HERE</li>');for(j.css({top:d+"px",left:c+"px"}),"undefined"!=typeof u&&u.remove(),y.el=angular.element(f.document.elementFromPoint(b.clientX,b.clientY)),y.treeview=y.el;"undefined"!=typeof y.treeview[0].tagName&&"treeview"!==y.treeview[0].tagName.toLowerCase();)y.treeview=y.treeview.parent();if(y.list=y.treeview.children().eq(1),m(y.treeview))y.isDroppable=!1;else{if(y.isDroppable=!0,y.scope=y.treeview.scope(),y.node=y.scope.treeData||y.scope.subnode,y.node.subnodes&&y.el.hasClass("node-label"))y.dropToDir=!0,y.list_el=y.treeview,y.list=y.treeview.children().children().eq(-1),y.list.after(e),y.addAfterEl=!0,"undefined"!=typeof v&&v.removeClass("dropToDir"),v=y.treeview,v.addClass("dropToDir");else{for(y.dropToDir=!1,"undefined"!=typeof y.node.subnodes&&(y.node=y.scope.$parent.treedata),y.treeview=y.treeview.parent(),y.list_el=y.treeview;"undefined"!=typeof y.treeview[0].tagName&&"treeview"!==y.treeview[0].tagName.toLowerCase();)y.treeview=y.treeview.parent();y.list=y.list_el.after(),b.clientY>y.list[0].getBoundingClientRect().top+y.list[0].offsetHeight/2?(y.list.after(e),y.addAfterEl=!0):(y.list.prepend(e),y.addAfterEl=!1)}u=e}y.dropToDir===!1&&"undefined"!=typeof v&&v.removeClass("dropToDir"),"function"==typeof a.treesettings.customMethods.dragging&&a.treesettings.customMethods.dragging(h,a,y,j)}function l(){var b,c,d,f,i,m=g.defer(),n=m.promise;y.isDroppable?(y.scope=y.treeview.scope(),y.node=y.scope.treeData||y.scope.subnode,b=a.treedata,i=a.$parent.$parent.treedata,d=i.subnodes.indexOf(b),y.dropToDir?(c=y.node.subnodes.length,y.node.expanded||(y.node.expanded=!0)):(f=y.el.scope().treedata,c=y.addAfterEl?y.node.subnodes.indexOf(f)+1:y.node.subnodes.indexOf(f)),n.then(function(a){var c=a||0;y.node.subnodes===i.subnodes&&d>c?(i.subnodes.splice(d,1),y.node.subnodes.splice(c,0,b)):(y.node.subnodes.splice(c,0,b),i.subnodes.splice(d,1))}),"function"==typeof a.treesettings.customMethods.dragEnd?a.treesettings.customMethods.dragEnd(y.isDroppable,h,a,y,m):m.resolve(c)):"function"==typeof a.treesettings.customMethods.dragEnd&&a.treesettings.customMethods.dragEnd(y.isDroppable,h,a,y,m),w=x=0,t[0].removeChild(s),"undefined"!=typeof u&&u.remove(),"undefined"!=typeof v&&v.removeClass("dropToDir"),y.isDroppable=!1,h.el.removeClass("dragging"),j.removeClass("dragged").removeAttr("style"),e.off("mousemove",k).off("mouseup",l)}function m(a){var b=a;if(b.hasClass("ghost")||"root"===b.attr("treeview-element-type"))return!0;for(;"undefined"!=typeof b[0]&&"root"!==b.attr("treeview-element-type");){if("undefined"==typeof b[0].tagName)return!0;if("treeview"===b[0].tagName.toLowerCase()&&b.hasClass("ghost"))return!0;b=b.parent()}return!1}function n(a){if("undefined"!=typeof a)for(;"undefined"!=typeof a&&"root"!==a.attr("treeview-element-type");)if(a=a.parent(),"root"===a.attr("treeview-element-type"))return{el:a,scope:a.scope()}}var o,p,q,r,s,t,u,v,w=0,x=0,y={el:null,node:null,list:null,list_el:null,treeview:null,scope:null,addAfterEl:!0,dropToDir:!1,isDroppable:!1};"undefined"!=typeof a.treesettings?angular.copy(a.treesettings,i):a.treesettings=i,a.$watch("treesettings",function(){}),o=a.treesettings.template||"templates/ioki-treeview",p=c.get(o),q=d(p)(a),j.append(q),r={scope:a,element:j,treesettings:a.treesettings},b(r),"root"!==j.attr("treeview-element-type")?j.on("mousedown touchstart",function(b){var c;"i"!==b.target.tagName.toLowerCase()&&"a"!==b.target.tagName.toLowerCase()&&2!==b.button&&3!==b.which&&(b.preventDefault(),b.stopPropagation(),"undefined"==typeof h.el&&(h=n(j)),t=j.parent(),s=j[0].cloneNode(!0),s.className="ghost",j.after(s),w=b.pageX-j[0].offsetLeft,x=b.pageY-j[0].offsetTop,c=j[0].offsetWidth,h.el.addClass("dragging"),j.addClass("dragged").css({left:j[0].offsetLeft+"px",top:j[0].offsetTop+"px",width:c+"px"}),e.on("mousemove touchmove",k).on("mouseup touchend",l),"function"==typeof a.treesettings.customMethods.dragStart&&a.treesettings.customMethods.dragStart(h,a,j))}):(r.treesettings.showExpander&&j.addClass("show-expander"),r.treesettings.removable||j.addClass("unremovable"),r.treesettings.addable||j.addClass("unaddable"))})}}}]),angular.module("ioki.treeview").run(["$templateCache",function(a){"use strict";a.put("templates/ioki-treeview",'<div bindonce\n     bo-class="{\'dir\': treedata.subnodes}"\n     ng-class="{\'expanded\': treedata.expanded, \'selected\': treedata.selected}"\n     ng-click="$selectNode()">\n\n    <!-- expander icon -->\n    <i class="expander"\n       bo-class="treesettings.iconsBaseClass"\n       ng-click="$toggleNode()"></i>\n\n    <!-- node icon -->\n    <i class="node-icon"\n       bo-class="treesettings.iconsBaseClass"></i>\n\n    <!-- node label -->\n    <span class="node-label" bo-text="treedata.name"></span>\n\n    <!-- remove node icon -->\n    <i class="remove-node"\n       bo-class="treesettings.iconsBaseClass"\n       ng-click="$removeNode()"></i>\n\n    <!-- add node icon -->\n    <i class="add-node"\n       bo-class="treesettings.iconsBaseClass"\n       ng-click="$addNode()"></i>\n</div>\n<ul ng-show="treedata.subnodes">\n    <li ng-repeat="subnode in treedata.subnodes track by $index">\n        <treeview treedata="subnode" treesettings="treesettings"></treeview>\n    </li>\n</ul>')}]),angular.module("ioki.treeview").filter("getNodeIcon",function(){"use strict";return function(a,b){var c;return"string"==typeof a.type&&"undefined"!=typeof b[a.type]?(c=b[a.type],null!==c&&"object"==typeof c?(a.expanded=a.expanded||!1,a.expanded?c.open:c.closed):c):null}});