angular.module("RecursionHelper",[]).factory("RecursionHelper",["$compile",function(a){"use strict";return{compile:function(b,c){angular.isFunction(c)&&(c={post:c});var d,e=b.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c&&c.post&&c.post.apply(null,arguments)}}}}}]),angular.module("ioki.treeview",["RecursionHelper"]).provider("$treeview",function(){"use strict";var a=this.defaults={prefixClass:"treeview-",prefixEvent:"treeview",treesettings:{template:"templates/ioki-treeview",iconsBaseClass:"fa",interfaceIcons:{addNode:"fa-plus-circle",removeNode:"fa-minus-circle",openDir:"fa-caret-down",closeDir:"fa-caret-right"},expandable:!0,expandAll:!0,showExpander:!0,removable:!1,addable:!0,selectable:!1,customMethods:{addNode:null,removeNode:null,dragStart:null,dragEnd:null,dragging:null,drop:null}}};this.$get=function(){function b(b){function c(a,b){var c,f,h;"string"==typeof a&&"undefined"!=typeof b&&(c=e(g),f=c.treedata,h=f.subnodes,f[a]=b,d(h,a,b))}function d(a,b,c){var e,f;if(angular.isArray(a))for(e=0,f=a.length,e;f>e;e++)a[e][b]=c,d(a[e].subnodes,b,c)}function e(a){return"undefined"==typeof a.$parent.$parent.treedata?a:e(a.$parent.$parent)}var f,g,h,i={};f=i.$options=angular.extend({},a,b);for(h in a.treesettings)a.treesettings.hasOwnProperty(h)&&"undefined"==typeof b.treesettings[h]&&(f.treesettings[h]=a.treesettings[h]);if("undefined"!=typeof b.treesettings.interfaceIcons)for(h in a.treesettings.interfaceIcons)a.treesettings.interfaceIcons.hasOwnProperty(h)&&"undefined"==typeof b.treesettings.interfaceIcons[h]&&(f.treesettings.interfaceIcons[h]=a.treesettings.interfaceIcons[h]);return g=i.$scope=f.scope,g.treesettings=f.treesettings,g.treedata.$removable="undefined"!=typeof g.$parent.$parent.treedata&&f.treesettings.removable?!0:!1,f.treesettings.expandAll&&(g.treedata.expanded=!0),g.$addNode=function(a){i.addNode(a)},g.$removeNode=function(){i.removeNode()},g.$toggleNode=function(){i.toggleNode()},g.$selectNode=function(){i.selectNode()},i.toggleNode=function(){f.treesettings.expandable&&(g.treedata.expanded=!g.treedata.expanded)},i.selectNode=function(){var a;f.treesettings.selectable&&(a=g.treedata.selected,c("selected",!1),g.treedata.selected=!a)},i.addNode=function(a){f.treesettings.addable&&"function"==typeof f.treesettings.customMethods.addNode&&f.treesettings.customMethods.addNode(g,a)},i.removeNode=function(){var a,b,c,d=g.treedata;f.treesettings.removable&&("function"==typeof f.treesettings.customMethods.removeNode?f.treesettings.customMethods.removeNode(g):(a=g.$parent.$parent.treedata,"undefined"!=typeof a&&(b=a.subnodes,angular.isArray(b)&&(c=b.indexOf(d),c>-1&&b.splice(c,1)))))},i}return b}}).directive("treeview",["RecursionHelper","$treeview","$templateCache","$compile","$document","$window",function(a,b,c,d,e,f){"use strict";var g;return{restrict:"E",transclude:!0,scope:{treedata:"=",treesettings:"="},compile:function(h){return"undefined"==typeof g&&(h.attr("treeview-element-type","root"),g={}),a.compile(h,function(a,h){function i(b){var c=b.pageX+10,d=b.pageY+10,e=angular.element('<li class="separator">DROP ITEM HERE</li>');for(h.css({top:d+"px",left:c+"px"}),"undefined"!=typeof s&&s.remove(),w.el=angular.element(f.document.elementFromPoint(b.pageX,b.pageY)),w.treeview=w.el;"undefined"!=typeof w.treeview[0].tagName&&"treeview"!==w.treeview[0].tagName.toLowerCase();)w.treeview=w.treeview.parent();if(w.list=w.treeview.children().eq(1),k(w.treeview))w.isDroppable=!1;else{if(w.isDroppable=!0,w.scope=w.treeview.scope(),w.node=w.scope.treeData||w.scope.subnode,w.node.subnodes&&w.el.hasClass("node-label"))w.dropToDir=!0,w.list_el=w.treeview,w.list=w.treeview.children().children().eq(-1),"undefined"!=typeof t&&t.removeClass("dropToDir"),t=w.treeview,t.addClass("dropToDir");else{for(w.dropToDir=!1,w.treeview=w.treeview.parent(),w.list_el=w.treeview;"undefined"!=typeof w.treeview[0].tagName&&"treeview"!==w.treeview[0].tagName.toLowerCase();)w.treeview=w.treeview.parent();w.list=w.list_el.after()}w.list.after(e),s=e}w.dropToDir===!1&&"undefined"!=typeof t&&t.removeClass("dropToDir"),"function"==typeof a.treesettings.customMethods.dragging&&a.treesettings.customMethods.dragging(g,a,w,h)}function j(){var b,c,d,f,k;w.isDroppable&&(w.scope=w.treeview.scope(),w.node=w.scope.treeData||w.scope.subnode,b=a.treedata,k=a.$parent.$parent.treedata,d=k.subnodes.indexOf(b),w.dropToDir?(c=w.node.subnodes.length,w.node.expanded||(w.node.expanded=!0)):(f=w.list_el.children().eq(0).scope().subnode,c=w.node.subnodes.indexOf(f)+1),w.scope.$apply(function(){k.subnodes.splice(d,1),w.node.subnodes.splice(c,0,b)})),"function"==typeof a.treesettings.customMethods.dropped&&a.treesettings.customMethods.dropped(g.scope(),a,w,h),u=v=0,r[0].removeChild(q),"undefined"!=typeof s&&s.remove(),"undefined"!=typeof t&&t.removeClass("dropToDir"),w.isDroppable=!1,g.el.removeClass("dragging"),h.removeClass("dragged").removeAttr("style"),e.off("mousemove",i).off("mouseup",j),"function"==typeof a.treesettings.customMethods.dragEnd&&a.treesettings.customMethods.dragEnd(g,a,h)}function k(a){var b=a;if(b.hasClass("ghost")||"root"===b.attr("treeview-element-type"))return!0;for(;"undefined"!=typeof b[0]&&"root"!==b.attr("treeview-element-type");){if("undefined"==typeof b[0].tagName)return!0;if("treeview"===b[0].tagName.toLowerCase()&&b.hasClass("ghost"))return!0;b=b.parent()}return!1}function l(a){if("undefined"!=typeof a)for(;"undefined"!=typeof a&&"root"!==a.attr("treeview-element-type");)if(a=a.parent(),"root"===a.attr("treeview-element-type"))return{el:a,scope:a.scope()}}var m,n,o,p,q,r,s,t,u=0,v=0,w={el:null,node:null,list:null,list_el:null,treeview:null,scope:null,dropToDir:!1,isDroppable:!1};m=a.treesettings.template||"templates/ioki-treeview",n=c.get(m),o=d(n)(a),h.append(o),p={scope:a,element:h,treesettings:{}},angular.isDefined(a.treesettings)&&angular.copy(a.treesettings,p.treesettings),b(p),"root"!==h.attr("treeview-element-type")&&h.on("mousedown touchstart",function(b){var c;"i"!==b.target.tagName.toLowerCase()&&"a"!==b.target.tagName.toLowerCase()&&2!==b.button&&3!==b.which&&(b.preventDefault(),b.stopPropagation(),"undefined"==typeof g.el&&(g=l(h)),r=h.parent(),q=h[0].cloneNode(!0),q.className="ghost",h.after(q),u=b.pageX-h[0].offsetLeft,v=b.pageY-h[0].offsetTop,c=h[0].offsetWidth,g.el.addClass("dragging"),h.addClass("dragged").css({left:h[0].offsetLeft+"px",top:h[0].offsetTop+"px",width:c+"px"}),e.on("mousemove touchmove",i).on("mouseup touchend",j),"function"==typeof a.treesettings.customMethods.dragStart&&a.treesettings.customMethods.dragStart(g,a,h))})})}}}]),angular.module("ioki.treeview").run(["$templateCache",function(a){"use strict";a.put("templates/ioki-treeview",'<div ng-class="{\'expanded\': treedata.expanded, \'selected\': treedata.selected}"\n     ng-click="$selectNode()">\n    <!-- expander icon -->\n    <i class="expander {{treesettings.iconsBaseClass}}"\n       ng-class="(treedata.subnodes && treesettings.showExpander) ? (treedata.expanded ? treesettings.interfaceIcons.openDir : treesettings.interfaceIcons.closeDir) : \'invisible\'"\n       ng-click="$toggleNode()"></i>\n\n    <!-- node icon -->\n    <i class="{{treesettings.iconsBaseClass}} {{treedata | getNodeIcon: treesettings.icons}}"></i>\n\n    <!-- node label -->\n    <span class="node-label">{{ treedata.name }}</span>\n\n    <!-- remove node icon -->\n    <i class="remove-node {{treesettings.iconsBaseClass}} {{treesettings.interfaceIcons.removeNode}}"\n       ng-click="$removeNode()"\n       ng-class="{\'invisible\': !treedata.$removable}"></i>\n\n    <!-- add node icon -->\n    <i class="add-node {{treesettings.iconsBaseClass}} {{treesettings.interfaceIcons.addNode}}"\n       ng-click="$addNode()"\n       ng-class="{\'invisible\': (!treesettings.addable || !treedata.subnodes)}"></i>\n</div>\n<ul ng-class="{\'expanded\': treedata.expanded}">\n    <li ng-repeat="subnode in treedata.subnodes track by $index">\n        <treeview treedata="subnode" treesettings="treesettings"></treeview>\n    </li>\n</ul>')}]),angular.module("ioki.treeview").filter("getNodeIcon",function(){"use strict";return function(a,b){var c;return"string"==typeof a.type&&"undefined"!=typeof b[a.type]?(c=b[a.type],null!==c&&"object"==typeof c?(a.expanded=a.expanded||!1,a.expanded?c.open:c.closed):c):null}});